<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALB - Raccolta dati</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; color:#333; margin:0; padding:40px; }
    .container { max-width:520px; margin:40px auto; background:#fff; border-radius:12px; padding:30px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#0078d7; font-size:22px; margin-bottom:5px; }
    .sub { text-align:center; font-size:13px; color:#666; margin-bottom:20px; }
    label { display:block; margin-top:15px; font-weight:bold; }
    input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    button { margin-top:25px; width:100%; padding:12px; background:#0078d7; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    button:hover { background:#005fa3; }
    .note { text-align:center; color:#555; margin-top:20px; font-size:13px; min-height:1.2em; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="titolo"></h1>
    <p class="sub" id="sottotitolo"></p>

    <label for="produzione">Produzione (kWh)</label>
    <input type="number" id="produzione" placeholder="Inserisci valore" step="any" min="0">

    <label for="acquisto">Acquisto (kWh)</label>
    <input type="number" id="acquisto" placeholder="Inserisci valore" step="any" min="0">

    <label for="cessione">Cessione (kWh)</label>
    <input type="number" id="cessione" placeholder="Inserisci valore" step="any" min="0">

    <button id="btnInvia" onclick="inviaDati()">üì§ Invia dati</button>

    <p class="note" id="messaggio"></p>
  </div>

  <script>
    const mesi = ["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
    let meseRifNum = null;  // 1..12
    let annoRif = null;

    // calcola mese/anno di riferimento (mese precedente)
    (function initPeriodo(){
      const oggi = new Date();
      const meseCorr = oggi.getMonth(); // 0..11
      const annoCorr = oggi.getFullYear();

      if (meseCorr === 0) {
        // gennaio -> prendo dicembre anno precedente
        meseRifNum = 12;
        annoRif = annoCorr - 1;
      } else {
        meseRifNum = meseCorr; // es. novembre (10) -> meseRif = 10 -> ottobre
        annoRif = annoCorr;
      }

      const titolo = document.getElementById("titolo");
      const sottotitolo = document.getElementById("sottotitolo");
      const nomeMese = mesi[meseRifNum - 1]; // 0..11

      titolo.innerText = `ALB ‚Äì rilevazione mese ${nomeMese} ${annoRif}`;
      sottotitolo.innerText = "Compila i dati e premi Invia.";
    })();

    async function inviaDati() {
      const produzione = document.getElementById("produzione").value;
      const acquisto   = document.getElementById("acquisto").value;
      const cessione   = document.getElementById("cessione").value;
      const messaggio  = document.getElementById("messaggio");
      const btn        = document.getElementById("btnInvia");

      if (!produzione || !acquisto || !cessione) return setMsg("‚ö†Ô∏è Compila tutti i campi.", "red");
      if (+produzione < 0 || +acquisto < 0 || +cessione < 0) return setMsg("‚ö†Ô∏è I valori devono essere ‚â• 0.", "red");

      const payload = {
        codice_cliente: "ALB",
        anno: annoRif,
        mese: meseRifNum,
        produzione: parseFloat(produzione),
        acquisto: parseFloat(acquisto),
        cessione: parseFloat(cessione),
        aggiornato_at: new Date().toISOString()
      };

      const endpoint = "https://tuo-endpoint.example.com/letture"; // <-- da fare lato server

      try {
        btn.disabled = true;
        setMsg("‚è≥ Invio in corso‚Ä¶", "#555");

        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = null;
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          return setMsg(`‚ùå Errore: ${data?.message || "Errore durante il salvataggio."}`, "red");
        }

        setMsg("‚úÖ Dati ricevuti.", "green");
        // se vuoi svuotare i campi:
        // document.getElementById("produzione").value = "";
        // document.getElementById("acquisto").value   = "";
        // document.getElementById("cessione").value   = "";
      } catch (e) {
        console.error(e);
        setMsg("‚ö†Ô∏è Errore di connessione al server.", "red");
      } finally {
        btn.disabled = false;
      }
    }

    function setMsg(text, color){
      const el = document.getElementById("messaggio");
      el.innerText = text;
      el.style.color = color;
    }
  </script>
</body>
</html>
